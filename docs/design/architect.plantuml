@startuml MGX_MVP_Architecture

!define RECTANGLE class

skinparam packageStyle rectangle
skinparam component {
    BackgroundColor<<frontend>> LightBlue
    BackgroundColor<<backend>> LightGreen
    BackgroundColor<<infrastructure>> LightYellow
    BackgroundColor<<external>> LightGray
    BackgroundColor<<leader>> Orange
}

package "Frontend Layer" {
    [Web UI] <<frontend>> as WebUI
    [Chat Interface\n(整合版)] <<frontend>> as ChatUI
    note right of ChatUI
        整合功能:
        - 对话消息流
        - Agent状态展示
        - 任务进度显示
        - 输入框
        - 工作流可视化
    end note
    [Code Editor\n(Monaco)] <<frontend>> as CodeEditor
    [File Manager] <<frontend>> as FileManager
    [Preview Panel] <<frontend>> as PreviewPanel
}

package "API Gateway Layer" {
    [FastAPI Gateway] <<backend>> as APIGateway
    [WebSocket Server] <<backend>> as WSServer
    [Authentication\nMiddleware] <<backend>> as AuthMiddleware
    note right of AuthMiddleware
        修复点3: WebSocket鉴权
        - JWT验证
        - Token刷新
        - 会话验证
    end note
}

package "Agent Orchestration Layer" {
    [Mike Agent\n(Team Leader)] <<leader>> as MikeAgent
    note right of MikeAgent
        核心决策者:
        - 直接管理团队成员
        - 通过Task Scheduler协调任务
        - 通过Message Router通信
    end note
    
    [Task Scheduler] <<backend>> as TaskScheduler
    note right of TaskScheduler
        任务调度中心:
        - 与所有Agent双向关联
        - 分配任务到Agent
        - 接收Agent完成通知
    end note
    
    [Message Router] <<backend>> as MessageRouter
    note right of MessageRouter
        消息路由中心:
        - 连接所有Agent
        - 路由Agent间消息
        - 发送状态到WebSocket
    end note
    
    package "Execution Team" {
        [Emma Agent\n(PM)] <<backend>> as EmmaAgent
        [Bob Agent\n(Architect)] <<backend>> as BobAgent
        [Alex Agent\n(Engineer)] <<backend>> as AlexAgent
        [David Agent\n(Data Analyst)] <<backend>> as DavidAgent
        [Iris Agent\n(Researcher)] <<backend>> as IrisAgent
    }
}

package "Core Services Layer" {
    [LLM Service] <<backend>> as LLMService
    [Tool Executor] <<backend>> as ToolExecutor
    [Code Sandbox] <<backend>> as CodeSandbox
    [Session Manager] <<backend>> as SessionManager
    note right of SessionManager
        修复点1: 完整依赖关系
        - API Gateway使用
        - WebSocket使用
        - 所有Agent使用
        - Tool Executor使用
        - Context Store双向
    end note
    [Context Store] <<backend>> as ContextStore
}

package "Tool & Integration Layer" {
    [Editor Tool] <<backend>> as EditorTool
    [Terminal Tool] <<backend>> as TerminalTool
    [Search Tool] <<backend>> as SearchTool
    [Git Integration] <<backend>> as GitTool
    [Supabase Client] <<backend>> as SupabaseClient
    [Preview Server] <<backend>> as PreviewServer
    note right of PreviewServer
        修复点2: 预览流程
        - 启动Code Sandbox中的应用
        - 配置nginx反向代理
        - 提供预览URL
    end note
}

package "Data Layer" {
    database "PostgreSQL\n(Sessions, Users)" <<infrastructure>> as PostgreSQL
    database "Redis\n(Cache, Queue)" <<infrastructure>> as Redis
    database "Vector DB\n(Embeddings)" <<infrastructure>> as VectorDB
    [File Storage\n(S3/Local)] <<infrastructure>> as FileStorage
}

package "External Services" {
    [OpenAI API] <<external>> as OpenAI
    [Anthropic API] <<external>> as Anthropic
    [Google Gemini] <<external>> as Gemini
    [GitHub API] <<external>> as GitHub
    [Supabase] <<external>> as Supabase
}

' Frontend connections
WebUI --> ChatUI
WebUI --> CodeEditor
WebUI --> FileManager
WebUI --> PreviewPanel

' Frontend to API Gateway
ChatUI --> APIGateway : REST/WebSocket
ChatUI --> WSServer : WebSocket (实时状态+流式输出)
CodeEditor --> APIGateway : REST
FileManager --> APIGateway : REST
PreviewPanel --> APIGateway : REST
PreviewPanel --> PreviewServer : 预览URL访问

' API Gateway connections
APIGateway --> AuthMiddleware : 鉴权
AuthMiddleware --> MikeAgent : 所有请求到Mike
WSServer --> AuthMiddleware : WebSocket鉴权
WSServer --> MessageRouter

' Mike manages team directly
MikeAgent --> EmmaAgent : 直接管理
MikeAgent --> BobAgent : 直接管理
MikeAgent --> AlexAgent : 直接管理
MikeAgent --> DavidAgent : 直接管理
MikeAgent --> IrisAgent : 直接管理

' Mike uses Task Scheduler and Message Router
MikeAgent --> TaskScheduler : 协调任务
MikeAgent --> MessageRouter : 发送消息

' Task Scheduler connects to all Agents (bidirectional)
TaskScheduler <--> EmmaAgent : 分配任务/完成通知
TaskScheduler <--> BobAgent : 分配任务/完成通知
TaskScheduler <--> AlexAgent : 分配任务/完成通知
TaskScheduler <--> DavidAgent : 分配任务/完成通知
TaskScheduler <--> IrisAgent : 分配任务/完成通知
TaskScheduler <--> MikeAgent : 协调

' Message Router connects to all Agents
MessageRouter <--> MikeAgent : 消息路由
MessageRouter <--> EmmaAgent : 消息路由
MessageRouter <--> BobAgent : 消息路由
MessageRouter <--> AlexAgent : 消息路由
MessageRouter <--> DavidAgent : 消息路由
MessageRouter <--> IrisAgent : 消息路由

' Message Router to WebSocket
MessageRouter --> WSServer : 广播状态更新

' All agents use core services
MikeAgent --> LLMService
EmmaAgent --> LLMService
BobAgent --> LLMService
AlexAgent --> LLMService
DavidAgent --> LLMService
IrisAgent --> LLMService

MikeAgent --> ToolExecutor
EmmaAgent --> ToolExecutor
BobAgent --> ToolExecutor
AlexAgent --> ToolExecutor
DavidAgent --> ToolExecutor
IrisAgent --> ToolExecutor

' Session Manager dependencies (修复点1)
APIGateway --> SessionManager : 会话管理
WSServer --> SessionManager : 会话验证
MikeAgent --> SessionManager : 获取会话
EmmaAgent --> SessionManager : 获取会话
BobAgent --> SessionManager : 获取会话
AlexAgent --> SessionManager : 获取会话
DavidAgent --> SessionManager : 获取会话
IrisAgent --> SessionManager : 获取会话
ToolExecutor --> SessionManager : 获取会话
LLMService --> SessionManager : 获取会话
SessionManager <--> ContextStore : 双向同步

' Core Services connections
ToolExecutor --> EditorTool
ToolExecutor --> TerminalTool
ToolExecutor --> SearchTool
ToolExecutor --> GitTool
ToolExecutor --> SupabaseClient

ToolExecutor --> CodeSandbox : 执行代码
TerminalTool --> CodeSandbox : 运行命令

' Preview Server connections (修复点2)
PreviewServer --> CodeSandbox : 启动应用
PreviewServer --> SessionManager : 获取会话文件
CodeSandbox --> PreviewServer : 应用端口

' Data Layer connections
SessionManager --> PostgreSQL
ContextStore --> Redis
ContextStore --> VectorDB
EditorTool --> FileStorage
CodeSandbox --> FileStorage

' External Services
LLMService --> OpenAI
LLMService --> Anthropic
LLMService --> Gemini
GitTool --> GitHub
SupabaseClient --> Supabase

note bottom of ChatUI
  新布局占比:
  ChatUI 30% | Editor+Preview 70%
  
  支持折叠以最大化预览空间
end note

note bottom of TaskScheduler
  优化点2:
  Task Scheduler与所有Agent双向关联
  分配任务 → Agent
  Agent → 完成通知
end note

note bottom of MessageRouter
  优化点3:
  Message Router连接所有Agent
  支持Agent间点对点通信
  所有Agent可发送状态到WebSocket
end note

@enduml