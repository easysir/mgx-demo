@startuml MGX_MVP_Architecture

!define RECTANGLE class

skinparam packageStyle rectangle
skinparam component {
    BackgroundColor<<frontend>> LightBlue
    BackgroundColor<<backend>> LightGreen
    BackgroundColor<<infrastructure>> LightYellow
    BackgroundColor<<external>> LightGray
    BackgroundColor<<leader>> Orange
}

package "Frontend Layer" {
    [Web UI] <<frontend>> as WebUI
    [Chat Interface\n(整合版)] <<frontend>> as ChatUI
    note right of ChatUI
        整合功能:
        - 对话消息流
        - Agent状态展示
        - 任务进度显示
        - 输入框
        - 工作流可视化
    end note
    [Code Editor\n(Monaco)] <<frontend>> as CodeEditor
    [File Manager] <<frontend>> as FileManager
    [Preview Panel] <<frontend>> as PreviewPanel
}

package "API Gateway Layer" {
    [FastAPI Gateway] <<backend>> as APIGateway
    [WebSocket Server] <<backend>> as WSServer
    [Authentication\nMiddleware] <<backend>> as AuthMiddleware
}

package "Agent Orchestration Layer" {
    [Mike Agent\n(Team Leader)] <<leader>> as MikeAgent
    note right of MikeAgent
        核心决策者和协调者:
        - 唯一入口，接收所有用户请求
        - 需求分析和任务规划
        - 团队协调和任务分配
        - 进度监控和质量把关
        - 审查交付物并反馈用户
    end note
    
    [Agent Manager] <<backend>> as AgentManager
    note right of AgentManager
        技术支撑层:
        - 管理Agent实例
        - 消息路由
        - 会话状态维护
        - 执行Mike的指令
    end note
    
    [Task Scheduler] <<backend>> as TaskScheduler
    [Message Router] <<backend>> as MessageRouter
    
    package "Execution Team" {
        [Emma Agent\n(PM)] <<backend>> as EmmaAgent
        [Bob Agent\n(Architect)] <<backend>> as BobAgent
        [Alex Agent\n(Engineer)] <<backend>> as AlexAgent
        [David Agent\n(Data Analyst)] <<backend>> as DavidAgent
        [Iris Agent\n(Researcher)] <<backend>> as IrisAgent
    }
}

package "Core Services Layer" {
    [LLM Service] <<backend>> as LLMService
    [Tool Executor] <<backend>> as ToolExecutor
    [Code Sandbox] <<backend>> as CodeSandbox
    [Session Manager] <<backend>> as SessionManager
    [Context Store] <<backend>> as ContextStore
}

package "Tool & Integration Layer" {
    [Editor Tool] <<backend>> as EditorTool
    [Terminal Tool] <<backend>> as TerminalTool
    [Search Tool] <<backend>> as SearchTool
    [Git Integration] <<backend>> as GitTool
    [Supabase Client] <<backend>> as SupabaseClient
}

package "Data Layer" {
    database "PostgreSQL\n(Sessions, Users)" <<infrastructure>> as PostgreSQL
    database "Redis\n(Cache, Queue)" <<infrastructure>> as Redis
    database "Vector DB\n(Embeddings)" <<infrastructure>> as VectorDB
    [File Storage\n(S3/Local)] <<infrastructure>> as FileStorage
}

package "External Services" {
    [OpenAI API] <<external>> as OpenAI
    [Anthropic API] <<external>> as Anthropic
    [Google Gemini] <<external>> as Gemini
    [GitHub API] <<external>> as GitHub
    [Supabase] <<external>> as Supabase
}

' Frontend connections
WebUI --> ChatUI
WebUI --> CodeEditor
WebUI --> FileManager
WebUI --> PreviewPanel

' Frontend to API Gateway
ChatUI --> APIGateway : REST/WebSocket
ChatUI --> WSServer : WebSocket (实时状态+流式输出)
CodeEditor --> APIGateway : REST
FileManager --> APIGateway : REST
PreviewPanel --> APIGateway : REST

' API Gateway connections
APIGateway --> AuthMiddleware
AuthMiddleware --> MikeAgent : 所有请求先到Mike
WSServer --> MessageRouter

' Mike as central coordinator
MikeAgent --> AgentManager : 使用技术支撑
MikeAgent --> TaskScheduler : 创建和监控任务
MikeAgent --> MessageRouter : 发送指令和接收汇报

' Agent Manager supports Mike
AgentManager --> EmmaAgent : 管理实例
AgentManager --> BobAgent : 管理实例
AgentManager --> AlexAgent : 管理实例
AgentManager --> DavidAgent : 管理实例
AgentManager --> IrisAgent : 管理实例

' Execution team reports to Mike
EmmaAgent --> MikeAgent : 完成后汇报
BobAgent --> MikeAgent : 完成后汇报
AlexAgent --> MikeAgent : 完成后汇报
DavidAgent --> MikeAgent : 完成后汇报
IrisAgent --> MikeAgent : 完成后汇报

' All agents use core services
MikeAgent --> LLMService
EmmaAgent --> LLMService
BobAgent --> LLMService
AlexAgent --> LLMService
DavidAgent --> LLMService
IrisAgent --> LLMService

MikeAgent --> ToolExecutor
EmmaAgent --> ToolExecutor
BobAgent --> ToolExecutor
AlexAgent --> ToolExecutor
DavidAgent --> ToolExecutor
IrisAgent --> ToolExecutor

' Core Services connections
ToolExecutor --> EditorTool
ToolExecutor --> TerminalTool
ToolExecutor --> SearchTool
ToolExecutor --> GitTool
ToolExecutor --> SupabaseClient

LLMService --> SessionManager
SessionManager --> ContextStore
ToolExecutor --> CodeSandbox

' Data Layer connections
SessionManager --> PostgreSQL
ContextStore --> Redis
ContextStore --> VectorDB
EditorTool --> FileStorage
CodeSandbox --> FileStorage

' External Services
LLMService --> OpenAI
LLMService --> Anthropic
LLMService --> Gemini
GitTool --> GitHub
SupabaseClient --> Supabase

note bottom of ChatUI
  新布局占比:
  ChatUI 30% | Editor+Preview 70%
  
  支持折叠以最大化预览空间
end note

@enduml