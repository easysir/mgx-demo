@startuml MGX_MVP_Sequence_Diagram

actor User
participant "Web UI" as UI
participant "API Gateway" as API
participant "WebSocket" as WS
participant "Mike Agent\n(Team Leader)" as Mike
participant "Agent Manager" as AM
participant "Emma Agent" as Emma
participant "Bob Agent" as Bob
participant "Alex Agent" as Alex
participant "LLM Service" as LLM
participant "Tool Executor" as TE
participant "Database" as DB

== 阶段1: 会话初始化 ==
User -> UI: 访问平台
UI -> API: POST /api/sessions/create
API -> DB: 创建会话
DB --> API: session_id
API --> UI: 返回session_id和ws_url
UI -> WS: 建立WebSocket连接
WS --> UI: 连接成功

== 阶段2: 用户提交需求 (Mike作为唯一入口) ==
User -> UI: 输入需求\n"创建一个作品集网站"
UI -> API: POST /api/chat/message
API -> Mike: 转发用户消息
note right of Mike
    Mike是唯一入口
    所有请求先到Mike
end note

Mike -> LLM: 分析需求
    note right
        Input: {
            "prompt": "分析用户需求...",
            "model": "gpt-4"
        }
    end note
LLM --> Mike: 需求分析结果
    note right
        Output: {
            "complexity": "medium",
            "needs_research": false,
            "needs_architecture": true,
            "estimated_tasks": [...]
        }
    end note

Mike -> Mike: 创建任务计划
Mike -> WS: 发送TaskOverviewMessage
    note right
        {
            "type": "task_overview",
            "agent": "Mike",
            "overall_progress": 0,
            "tasks": [
                {"id": "task-1", "assignee": "Bob", "description": "设计架构"},
                {"id": "task-2", "assignee": "Alex", "description": "开发代码"}
            ]
        }
    end note
WS --> UI: 显示任务总览

== 阶段3: Mike分配架构设计任务 ==
Mike -> AM: 获取Bob实例
AM --> Mike: Bob Agent实例
Mike -> Bob: 分配任务\n"设计作品集网站架构"
    note right
        Mike决策: 需要先设计架构
    end note

Bob -> WS: 发送AgentMessage(status='working')
    note right
        {
            "type": "agent_message",
            "agent": "Bob",
            "status": "working",
            "content": "正在设计系统架构...",
            "progress": 0
        }
    end note
WS --> UI: ChatUI显示Bob工作状态

Bob -> TE: execute_tool("Editor.read", "requirements")
TE --> Bob: 需求内容

Bob -> LLM: 生成架构设计
    note right
        Input: {
            "prompt": "设计架构...",
            "model": "claude-3-sonnet"
        }
    end note
LLM --> Bob: 架构设计方案

Bob -> WS: 更新进度(progress=50)
WS --> UI: 更新进度条

Bob -> TE: execute_tool("Editor.write", "architecture.md")
TE --> Bob: 写入成功

Bob -> WS: 发送AgentMessage(status='completed', progress=100)
WS --> UI: 显示Bob完成状态✅

Bob -> Mike: 汇报完成\n返回架构设计
    note right
        Bob完成后向Mike汇报
        不是向Agent Manager汇报
    end note

== 阶段4: Mike评估并分配开发任务 ==
Mike -> Mike: 评估Bob的架构设计
    note right
        Mike审查交付物
        决定下一步行动
    end note

Mike -> LLM: 评估架构质量
LLM --> Mike: 评估结果: 通过

Mike -> WS: 更新TaskOverview(overall_progress=50)
WS --> UI: 更新整体进度

Mike -> AM: 获取Alex实例
AM --> Mike: Alex Agent实例
Mike -> Alex: 分配任务\n"根据架构实现代码"
    note right
        Mike决策: 架构通过，开始开发
    end note

Alex -> WS: 发送AgentMessage(status='working')
WS --> UI: ChatUI显示Alex工作状态

Alex -> TE: execute_tool("Editor.read", "architecture.md")
TE --> Alex: 架构文档

loop 为每个组件生成代码
    Alex -> LLM: 生成组件代码
        note right
            Input: {
                "prompt": "根据架构生成代码...",
                "model": "gpt-4"
            }
        end note
    LLM --> Alex: 组件代码
    
    Alex -> WS: 更新进度(progress=20, 40, 60...)
    WS --> UI: 实时更新进度条
    
    Alex -> TE: execute_tool("Editor.write", "component.tsx")
    TE --> Alex: 写入成功
end

Alex -> TE: execute_tool("Terminal.run", "npm install")
TE --> Alex: 安装完成

Alex -> WS: 更新进度(progress=80)
WS --> UI: 更新进度条

Alex -> TE: execute_tool("Terminal.run", "npm run build")
TE --> Alex: 构建成功

Alex -> WS: 发送AgentMessage(status='completed', progress=100)
WS --> UI: 显示Alex完成状态✅

Alex -> Mike: 汇报完成\n返回代码和构建结果
    note right
        Alex完成后向Mike汇报
    end note

== 阶段5: Mike审查并通知用户 ==
Mike -> Mike: 审查Alex的代码
    note right
        Mike进行最终质量把关
    end note

Mike -> LLM: 代码审查
LLM --> Mike: 审查结果: 通过

Mike -> WS: 更新TaskOverview(overall_progress=100)
WS --> UI: 显示所有任务完成

Mike -> WS: 发送完成消息给用户
    note right
        {
            "type": "message",
            "role": "assistant",
            "content": "作品集网站已完成开发，\n可以预览和部署了。"
        }
    end note
WS --> UI: 显示Mike的消息
UI --> User: 展示完成通知

== 阶段6: 用户预览和部署 ==
User -> UI: 点击"预览"
UI -> API: GET /api/preview/{session_id}
API -> DB: 获取文件列表
DB --> API: 文件数据
API --> UI: 返回文件
UI --> User: 渲染预览

User -> UI: 点击"部署"
UI -> API: POST /api/deploy
API -> Mike: 转发部署请求
    note right
        部署请求也通过Mike
    end note

Mike -> Alex: 分配部署任务
Alex -> WS: 发送AgentMessage(status='working', content='正在部署...')
WS --> UI: 显示部署状态

Alex -> TE: execute_tool("Git.push")
TE --> Alex: 推送成功

Alex -> TE: execute_tool("Deploy.vercel")
TE --> Alex: 部署URL

Alex -> Mike: 汇报部署完成
Mike -> WS: 发送部署成功消息\n包含URL
WS --> UI: 显示部署链接
UI --> User: 展示部署结果

== 阶段7: 上下文持久化 ==
Mike -> DB: 保存会话上下文
DB --> Mike: 保存成功

@enduml