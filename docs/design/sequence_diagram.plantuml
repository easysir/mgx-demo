@startuml MGX_MVP_Sequence_Diagram

actor User
participant "Web UI" as UI
participant "API Gateway" as API
participant "WebSocket Server" as WS
participant "Mike Agent\n(Team Leader)" as Mike
participant "Task Scheduler" as TS
participant "Message Router" as MR
participant "Bob Agent" as Bob
participant "Alex Agent" as Alex
participant "LLM Service" as LLM
participant "Tool Executor" as TE
participant "Session Manager" as SM
participant "Database" as DB

== 阶段1: 会话初始化 ==
User -> UI: 访问平台
UI -> API: POST /api/sessions/create
API -> SM: create_session(user_id)
SM -> DB: INSERT session
DB --> SM: session_id
SM --> API: Session对象
API --> UI: 返回session_id和ws_url
UI -> WS: 建立WebSocket连接
WS --> UI: 连接成功

== 阶段2: 用户提交需求 (Mike作为唯一入口) ==
User -> UI: 输入需求\n"创建一个作品集网站"
UI -> API: POST /api/chat/message
API -> Mike: 转发用户消息
note right of Mike
    Mike是唯一入口
    直接管理团队
end note

Mike -> LLM: 分析需求
LLM --> Mike: 需求分析结果

Mike -> Mike: 创建任务计划
Mike -> MR: 发送TaskOverviewMessage
MR -> WS: 广播任务总览
WS --> UI: ChatUI显示任务总览

== 阶段3: Mike通过Task Scheduler分配架构设计任务 ==
Mike -> TS: schedule_task(task-2, assignee="Bob")
note right of TS
    优化点2:
    Task Scheduler与所有Agent关联
end note

TS -> Bob: assign_task(task-2)
note right of Bob
    优化点3:
    所有Agent通过Message Router
    发送状态到WebSocket
end note

Bob -> MR: 发送AgentMessage(status='working')
MR -> WS: 广播Bob工作状态
WS --> UI: ChatUI显示Bob工作状态

Bob -> TE: execute_tool("Editor.read", "requirements")
TE --> Bob: 需求内容

Bob -> LLM: 生成架构设计
LLM --> Bob: 架构设计方案

Bob -> MR: 更新进度(progress=50)
MR -> WS: 广播进度更新
WS --> UI: 更新进度条

Bob -> TE: execute_tool("Editor.write", "architecture.md")
TE --> Bob: 写入成功

Bob -> MR: 发送AgentMessage(status='completed', progress=100)
MR -> WS: 广播完成状态
WS --> UI: 显示Bob完成✅

Bob -> TS: notify_task_completed(task-2)
note right of TS
    Task Scheduler接收完成通知
    通知Mike并分配下一个任务
end note

TS -> Mike: on_task_completed(task-2, Bob, result)

== 阶段4: Mike评估并分配开发任务 ==
Mike -> Mike: 评估Bob的架构设计
Mike -> LLM: 评估架构质量
LLM --> Mike: 评估结果: 通过

Mike -> MR: 更新TaskOverview(overall_progress=50)
MR -> WS: 广播整体进度
WS --> UI: 更新整体进度

Mike -> TS: schedule_task(task-3, assignee="Alex")
TS -> Alex: assign_task(task-3)

Alex -> MR: 发送AgentMessage(status='working')
MR -> WS: 广播Alex工作状态
WS --> UI: ChatUI显示Alex工作状态

Alex -> TE: execute_tool("Editor.read", "architecture.md")
TE --> Alex: 架构文档

loop 为每个组件生成代码
    Alex -> LLM: 生成组件代码
    LLM --> Alex: 组件代码
    
    Alex -> MR: 更新进度(progress=20, 40, 60...)
    MR -> WS: 广播进度更新
    WS --> UI: 实时更新进度条
    
    Alex -> TE: execute_tool("Editor.write", "component.tsx")
    TE --> Alex: 写入成功
end

Alex -> TE: execute_tool("Terminal.run", "npm install")
TE --> Alex: 安装完成

Alex -> MR: 更新进度(progress=80)
MR -> WS: 广播进度
WS --> UI: 更新进度条

Alex -> TE: execute_tool("Terminal.run", "npm run build")
TE --> Alex: 构建成功

Alex -> MR: 发送AgentMessage(status='completed', progress=100)
MR -> WS: 广播完成状态
WS --> UI: 显示Alex完成✅

Alex -> TS: notify_task_completed(task-3)
TS -> Mike: on_task_completed(task-3, Alex, result)

== 阶段5: Mike审查并通知用户 ==
Mike -> Mike: 审查Alex的代码
Mike -> LLM: 代码审查
LLM --> Mike: 审查结果: 通过

Mike -> MR: 更新TaskOverview(overall_progress=100)
MR -> WS: 广播完成
WS --> UI: 显示所有任务完成

Mike -> MR: 发送完成消息给用户
MR -> WS: 广播消息
WS --> UI: 显示Mike的消息
UI --> User: 展示完成通知

== 阶段6: 用户预览和部署 ==
User -> UI: 点击"预览"
UI -> API: GET /api/preview/{session_id}
API -> SM: get_session_files(session_id)
SM -> DB: 获取文件列表
DB --> SM: 文件数据
SM --> API: 返回文件
API --> UI: 预览数据
UI --> User: 渲染预览

User -> UI: 点击"部署"
UI -> API: POST /api/deploy
API -> Mike: 转发部署请求

Mike -> TS: schedule_task(deploy_task, assignee="Alex")
TS -> Alex: assign_task(deploy_task)

Alex -> MR: 发送AgentMessage(status='working', content='正在部署...')
MR -> WS: 广播部署状态
WS --> UI: 显示部署状态

Alex -> TE: execute_tool("Git.push")
TE --> Alex: 推送成功

Alex -> TE: execute_tool("Deploy.vercel")
TE --> Alex: 部署URL

Alex -> MR: 发送AgentMessage(status='completed', content='部署成功')
MR -> WS: 广播部署成功
WS --> UI: 显示部署链接

Alex -> TS: notify_task_completed(deploy_task)
TS -> Mike: on_task_completed(deploy_task, Alex, result)

Mike -> MR: 发送部署成功消息
MR -> WS: 广播消息
WS --> UI: 显示部署结果
UI --> User: 展示部署链接

== 阶段7: 上下文持久化 ==
Mike -> SM: update_session_context(session_id, context)
SM -> DB: UPDATE sessions
DB --> SM: 保存成功

note over Mike, Alex
    架构优化总结:
    1. 移除Agent Manager - Mike直接管理团队
    2. Task Scheduler与所有Agent双向关联
    3. Message Router连接所有Agent
end note

@enduml